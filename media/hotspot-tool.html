<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Station Hotspot Editor</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: #0b0f1a;
      color: #f5f5f5;
    }
    header {
      padding: 0.75rem 1rem;
      background: #111827;
      display: flex;
      align-items: center;
      gap: 1rem;
      border-bottom: 1px solid #1f2937;
      flex-wrap: wrap;
    }
    header h1 { margin: 0; font-size: 1.1rem; }
    header select, header input {
      padding: 0.5rem;
      border-radius: 4px;
      border: 1px solid #374151;
      background: #0b0f1a;
      color: #f5f5f5;
      font-size: 13px;
    }
    #workspace {
      flex: 1;
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 1rem;
      padding: 1rem;
    }
    #image-wrapper {
      position: relative;
      background: #05080f;
      border: 2px solid #1f2937;
      border-radius: 8px;
      overflow: hidden;
    }
    #station-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }
    #svg-overlay {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    #click-overlay {
      position: absolute;
      inset: 0;
      cursor: crosshair;
    }
    #controls {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      overflow-y: auto;
    }
    button {
      padding: 0.65rem;
      border-radius: 0.4rem;
      border: none;
      background: #2563eb;
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
    button:hover { background: #1d4ed8; }
    button:disabled { opacity: 0.4; cursor: not-allowed; }
    .secondary { background: #111827; border: 1px solid #374151; }
    .secondary:hover { background: #1f2937; }
    .success { background: #059669; }
    .success:hover { background: #047857; }
    .danger { background: #dc2626; }
    .danger:hover { background: #b91c1c; }
    label { font-size: 0.9rem; display: block; margin-bottom: 0.25rem; color: #9ca3af; }
    input, textarea, select {
      width: 100%;
      padding: 0.65rem;
      border-radius: 0.4rem;
      border: 1px solid #374151;
      background: #0b0f1a;
      color: #f5f5f5;
      font-family: inherit;
      font-size: 14px;
    }
    select { cursor: pointer; }
    textarea {
      min-height: 120px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 11px;
      resize: vertical;
    }
    #status {
      font-size: 0.85rem;
      color: #00d4ff;
      padding: 0.5rem;
      background: rgba(0,212,255,0.1);
      border-radius: 4px;
      border: 1px solid rgba(0,212,255,0.3);
    }
    #coords-list {
      margin: 0;
      padding: 0.5rem;
      list-style: none;
      font-size: 0.8rem;
      line-height: 1.5;
      max-height: 80px;
      overflow-y: auto;
      background: #111827;
      border-radius: 4px;
      font-family: monospace;
    }
    .btn-row { display: flex; gap: 0.5rem; }
    .btn-row button { flex: 1; }
    h3 { margin: 0.5rem 0; font-size: 0.9rem; color: #9ca3af; }
    #cursor-pos {
      position: fixed;
      bottom: 1rem;
      left: 1rem;
      background: rgba(0,0,0,0.8);
      padding: 0.5rem 1rem;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
      color: #00d4ff;
      pointer-events: none;
    }
    .hotspot-item {
      padding: 0.4rem 0.6rem;
      margin: 0.25rem 0;
      border-radius: 4px;
      background: #111827;
      cursor: pointer;
      font-size: 0.8rem;
      border: 1px solid transparent;
    }
    .hotspot-item:hover { background: #1f2937; }
    .hotspot-item.selected { border-color: #fbbf24; background: rgba(251,191,36,0.1); }
    .scene-info {
      padding: 0.5rem;
      background: #111827;
      border-radius: 4px;
      font-size: 0.85rem;
    }
    .scene-info strong { color: #00d4ff; }
  </style>
</head>
<body>

<header>
  <h1>ðŸ›¸ Hotspot Editor</h1>
  <label style="margin:0; display:flex; align-items:center; gap:0.5rem;">
    Scene:
    <select id="scene-select"></select>
  </label>
  <button id="download-btn" class="success">ðŸ’¾ Download station-map.json</button>
  <input type="file" id="load-file" accept=".json" style="display:none;">
  <button id="load-btn" class="secondary">ðŸ“‚ Load JSON</button>
</header>

<section id="workspace">
  <div id="image-wrapper">
    <img id="station-image" src="" alt="Scene">
    <svg id="svg-overlay" viewBox="0 0 2752 1536" preserveAspectRatio="xMidYMid meet">
      <g id="existing-hotspots"></g>
      <polyline id="current-polyline" points="" fill="none" stroke="#00d4ff" stroke-width="4" stroke-linejoin="round"/>
      <polygon id="finished-polygon" points="" fill="rgba(0,212,255,0.2)" stroke="#00d4ff" stroke-width="4" style="display:none"/>
      <g id="points-group"></g>
    </svg>
    <div id="click-overlay"></div>
  </div>

  <div id="controls">
    <div class="scene-info" id="scene-info">Loading...</div>

    <div id="status">Click on the image to trace a hotspot polygon.</div>

    <div>
      <label>Hotspot ID</label>
      <input type="text" id="hotspot-id" placeholder="e.g., bridge, back, sector1">
    </div>
    <div>
      <label>Label</label>
      <input type="text" id="hotspot-label" placeholder="e.g., Command Bridge">
    </div>
    <div>
      <label>Target Scene (leave empty for no navigation)</label>
      <input type="text" id="hotspot-target" placeholder="e.g., bridge, station">
    </div>

    <div class="btn-row">
      <button id="undo-point" class="secondary" disabled>Undo Point</button>
      <button id="close-polygon" disabled>Close Polygon</button>
    </div>

    <div class="btn-row">
      <button id="add-hotspot" class="success" disabled>Add Hotspot</button>
      <button id="clear-current" class="secondary">Clear Drawing</button>
    </div>

    <div>
      <h3>Points (<span id="point-count">0</span>)</h3>
      <ul id="coords-list"><li>(click image to add points)</li></ul>
    </div>

    <div>
      <h3>Hotspots in this scene (<span id="hotspot-count">0</span>)</h3>
      <div id="hotspot-list"></div>
    </div>

    <div class="btn-row">
      <button id="delete-selected" class="danger secondary" disabled>Delete Selected</button>
    </div>

    <div>
      <label>JSON Preview</label>
      <textarea id="json-output" readonly></textarea>
    </div>
  </div>
</section>

<div id="cursor-pos">x: 0, y: 0</div>

<script>
// Default station map structure
const DEFAULT_MAP = {
  version: 1,
  startScene: 'station',
  imageWidth: 2752,
  imageHeight: 1536,
  scenes: {
    station: { title: 'Station Exterior', image: 'imgs/Space Station.jpeg', hotspots: [] },
    bridge: { title: 'Command Bridge', image: 'imgs/Bridge Interior.jpeg', hotspots: [{ id: 'back', label: 'â† Back to Station', points: [{x:50,y:50},{x:350,y:50},{x:350,y:150},{x:50,y:150}], targetScene: 'station' }] },
    core: { title: 'Reactor Core', image: 'imgs/Engine Room.png', hotspots: [{ id: 'back', label: 'â† Back to Station', points: [{x:50,y:50},{x:350,y:50},{x:350,y:150},{x:50,y:150}], targetScene: 'station' }] },
    vault: { title: 'Cargo Vault', image: 'imgs/Cargo Holder.png', hotspots: [{ id: 'back', label: 'â† Back to Station', points: [{x:50,y:50},{x:350,y:50},{x:350,y:150},{x:50,y:150}], targetScene: 'station' }] },
    docking: { title: 'Gate Control', image: 'imgs/Gate Control .png', hotspots: [{ id: 'back', label: 'â† Back to Station', points: [{x:50,y:50},{x:350,y:50},{x:350,y:150},{x:50,y:150}], targetScene: 'station' }] },
    guard: { title: 'Armory', image: 'imgs/Armory.png', hotspots: [{ id: 'back', label: 'â† Back to Station', points: [{x:50,y:50},{x:350,y:50},{x:350,y:150},{x:50,y:150}], targetScene: 'station' }] },
    scanner: { title: 'Scanner Bay', image: 'imgs/Scannery Bay.png', hotspots: [{ id: 'back', label: 'â† Back to Station', points: [{x:50,y:50},{x:350,y:50},{x:350,y:150},{x:50,y:150}], targetScene: 'station' }] },
    comms: { title: 'Comms Deck', image: 'imgs/Comms Deck.png', hotspots: [{ id: 'back', label: 'â† Back to Station', points: [{x:50,y:50},{x:350,y:50},{x:350,y:150},{x:50,y:150}], targetScene: 'station' }] }
  }
};

let stationMap = JSON.parse(JSON.stringify(DEFAULT_MAP));
let currentSceneId = 'station';
let points = [];
let isClosed = false;
let sceneHotspots = [];
let selectedHotspotIndex = -1;

const overlay = document.getElementById('click-overlay');
const statusEl = document.getElementById('status');
const coordsList = document.getElementById('coords-list');
const pointCount = document.getElementById('point-count');
const hotspotCount = document.getElementById('hotspot-count');
const polyline = document.getElementById('current-polyline');
const polygon = document.getElementById('finished-polygon');
const pointsGroup = document.getElementById('points-group');
const existingHotspotsGroup = document.getElementById('existing-hotspots');
const jsonOutput = document.getElementById('json-output');
const closeBtn = document.getElementById('close-polygon');
const undoBtn = document.getElementById('undo-point');
const clearCurrentBtn = document.getElementById('clear-current');
const addHotspotBtn = document.getElementById('add-hotspot');
const downloadBtn = document.getElementById('download-btn');
const loadBtn = document.getElementById('load-btn');
const loadFile = document.getElementById('load-file');
const deleteBtn = document.getElementById('delete-selected');
const img = document.getElementById('station-image');
const cursorPos = document.getElementById('cursor-pos');
const sceneSelect = document.getElementById('scene-select');
const sceneInfo = document.getElementById('scene-info');
const hotspotIdInput = document.getElementById('hotspot-id');
const hotspotLabelInput = document.getElementById('hotspot-label');
const hotspotTargetInput = document.getElementById('hotspot-target');
const hotspotListEl = document.getElementById('hotspot-list');

function getUrlParam(name) {
  const params = new URLSearchParams(window.location.search);
  return params.get(name);
}

function getImageCoords(event) {
  const imgRect = img.getBoundingClientRect();
  const imgAspect = img.naturalWidth / img.naturalHeight;
  const containerAspect = imgRect.width / imgRect.height;

  let displayedWidth, displayedHeight, offsetX, offsetY;

  if (imgAspect > containerAspect) {
    displayedWidth = imgRect.width;
    displayedHeight = imgRect.width / imgAspect;
    offsetX = 0;
    offsetY = (imgRect.height - displayedHeight) / 2;
  } else {
    displayedHeight = imgRect.height;
    displayedWidth = imgRect.height * imgAspect;
    offsetX = (imgRect.width - displayedWidth) / 2;
    offsetY = 0;
  }

  const clickX = event.clientX - imgRect.left - offsetX;
  const clickY = event.clientY - imgRect.top - offsetY;
  const scaleX = img.naturalWidth / displayedWidth;
  const scaleY = img.naturalHeight / displayedHeight;

  return {
    x: Math.max(0, Math.min(img.naturalWidth, Math.round(clickX * scaleX))),
    y: Math.max(0, Math.min(img.naturalHeight, Math.round(clickY * scaleY)))
  };
}

function renderPolyline() {
  const coords = points.map(p => `${p.x},${p.y}`).join(' ');
  polyline.setAttribute('points', coords);
  polyline.style.display = isClosed ? 'none' : 'block';
}

function renderPolygon() {
  if (!isClosed || points.length < 3) {
    polygon.style.display = 'none';
    return;
  }
  const coords = points.map(p => `${p.x},${p.y}`).join(' ');
  polygon.setAttribute('points', coords);
  polygon.style.display = 'block';
}

function renderExistingHotspots() {
  existingHotspotsGroup.innerHTML = '';
  sceneHotspots.forEach((h, idx) => {
    if (!h.points || h.points.length < 3) return;
    const coords = h.points.map(p => `${p.x},${p.y}`).join(' ');
    const poly = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
    poly.setAttribute('points', coords);
    const isSelected = idx === selectedHotspotIndex;
    poly.setAttribute('fill', isSelected ? 'rgba(251,191,36,0.3)' : 'rgba(5,150,105,0.2)');
    poly.setAttribute('stroke', isSelected ? '#fbbf24' : '#059669');
    poly.setAttribute('stroke-width', isSelected ? '5' : '3');
    poly.style.cursor = 'pointer';
    poly.style.pointerEvents = 'all';
    poly.onclick = (e) => {
      e.stopPropagation();
      selectHotspot(idx);
    };
    existingHotspotsGroup.appendChild(poly);

    // Label
    const cx = h.points.reduce((s,p) => s + p.x, 0) / h.points.length;
    const cy = h.points.reduce((s,p) => s + p.y, 0) / h.points.length;
    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', cx);
    text.setAttribute('y', cy);
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('fill', isSelected ? '#fbbf24' : '#10b981');
    text.setAttribute('font-size', '28');
    text.setAttribute('font-weight', 'bold');
    text.style.pointerEvents = 'none';
    text.textContent = h.label || h.id || (idx + 1);
    existingHotspotsGroup.appendChild(text);
  });
}

function renderPoints() {
  pointsGroup.innerHTML = '';
  points.forEach((p, i) => {
    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    circle.setAttribute('cx', p.x);
    circle.setAttribute('cy', p.y);
    circle.setAttribute('r', '10');
    circle.setAttribute('fill', i === 0 ? '#00ff88' : '#00d4ff');
    circle.setAttribute('stroke', '#fff');
    circle.setAttribute('stroke-width', '2');
    pointsGroup.appendChild(circle);

    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', p.x);
    text.setAttribute('y', p.y + 4);
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('fill', '#000');
    text.setAttribute('font-size', '12');
    text.setAttribute('font-weight', 'bold');
    text.textContent = i + 1;
    pointsGroup.appendChild(text);
  });
}

function updateList() {
  pointCount.textContent = points.length;
  if (!points.length) {
    coordsList.innerHTML = '<li>(click image to add points)</li>';
    return;
  }
  coordsList.innerHTML = '';
  points.forEach((p, i) => {
    const li = document.createElement('li');
    li.textContent = `${i + 1}. (${p.x}, ${p.y})`;
    coordsList.appendChild(li);
  });
}

function updateHotspotList() {
  hotspotCount.textContent = sceneHotspots.length;
  hotspotListEl.innerHTML = '';
  if (!sceneHotspots.length) {
    hotspotListEl.innerHTML = '<div style="opacity:0.5;font-size:0.8rem;">No hotspots yet</div>';
    return;
  }
  sceneHotspots.forEach((h, idx) => {
    const div = document.createElement('div');
    div.className = 'hotspot-item' + (idx === selectedHotspotIndex ? ' selected' : '');
    div.textContent = `${h.id || '(no id)'} - ${h.label || '(no label)'}${h.targetScene ? ' â†’ ' + h.targetScene : ''}`;
    div.onclick = () => selectHotspot(idx);
    hotspotListEl.appendChild(div);
  });
}

function selectHotspot(idx) {
  selectedHotspotIndex = idx === selectedHotspotIndex ? -1 : idx;
  deleteBtn.disabled = selectedHotspotIndex < 0;
  renderExistingHotspots();
  updateHotspotList();
}

function updateJsonOutput() {
  jsonOutput.value = JSON.stringify(sceneHotspots, null, 2);
}

function updateButtons() {
  closeBtn.disabled = points.length < 3 || isClosed;
  undoBtn.disabled = points.length === 0 || isClosed;
  addHotspotBtn.disabled = !isClosed || points.length < 3;
}

function updateStatus(msg) {
  statusEl.textContent = msg || (isClosed ? 'Polygon closed. Fill in details and click "Add Hotspot".' : 'Click to add points (min 3), then close polygon.');
}

function clearDrawing() {
  points = [];
  isClosed = false;
  polyline.setAttribute('points', '');
  polygon.setAttribute('points', '');
  polygon.style.display = 'none';
  pointsGroup.innerHTML = '';
  updateList();
  updateButtons();
  updateStatus();
}

function populateSceneSelect() {
  sceneSelect.innerHTML = '';
  if (stationMap?.scenes) {
    Object.keys(stationMap.scenes).forEach(id => {
      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent = stationMap.scenes[id].title || id;
      if (id === currentSceneId) opt.selected = true;
      sceneSelect.appendChild(opt);
    });
  }
}

function loadScene(sceneId) {
  currentSceneId = sceneId;
  const scene = stationMap?.scenes?.[sceneId];
  if (!scene) {
    sceneInfo.innerHTML = '<strong>Scene not found</strong>';
    return;
  }

  sceneInfo.innerHTML = `<strong>${scene.title || sceneId}</strong><br>Image: ${scene.image || '(none)'}`;

  if (scene.image) {
    img.src = scene.image;
  }

  // Update SVG viewBox based on image dimensions
  const svgOverlay = document.getElementById('svg-overlay');
  if (stationMap.imageWidth && stationMap.imageHeight) {
    svgOverlay.setAttribute('viewBox', `0 0 ${stationMap.imageWidth} ${stationMap.imageHeight}`);
  }

  sceneHotspots = scene.hotspots ? JSON.parse(JSON.stringify(scene.hotspots)) : [];
  selectedHotspotIndex = -1;
  deleteBtn.disabled = true;

  clearDrawing();
  renderExistingHotspots();
  updateHotspotList();
  updateJsonOutput();
}

function saveCurrentSceneToMap() {
  if (stationMap?.scenes?.[currentSceneId]) {
    stationMap.scenes[currentSceneId].hotspots = JSON.parse(JSON.stringify(sceneHotspots));
  }
}

function downloadStationMap() {
  saveCurrentSceneToMap();
  const json = JSON.stringify(stationMap, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'station-map.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  updateStatus('Downloaded station-map.json! Replace the file in media/ folder.');
}

function loadStationMapFromFile(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const loaded = JSON.parse(e.target.result);
      stationMap = loaded;
      populateSceneSelect();
      loadScene(stationMap.startScene || 'station');
      updateStatus('Loaded station-map.json successfully!');
    } catch (err) {
      updateStatus('Error loading JSON: ' + err.message);
    }
  };
  reader.readAsText(file);
}

// Event listeners
overlay.addEventListener('click', (e) => {
  if (isClosed) return;
  const coords = getImageCoords(e);
  points.push(coords);
  renderPolyline();
  renderPoints();
  updateList();
  updateButtons();
  updateStatus();
});

overlay.addEventListener('mousemove', (e) => {
  const coords = getImageCoords(e);
  cursorPos.textContent = `x: ${coords.x}, y: ${coords.y}`;
});

sceneSelect.addEventListener('change', () => {
  saveCurrentSceneToMap();
  loadScene(sceneSelect.value);
});

closeBtn.addEventListener('click', () => {
  if (points.length < 3) return;
  isClosed = true;
  renderPolyline();
  renderPolygon();
  updateButtons();
  updateStatus();
});

undoBtn.addEventListener('click', () => {
  if (points.length === 0 || isClosed) return;
  points.pop();
  renderPolyline();
  renderPoints();
  updateList();
  updateButtons();
  updateStatus();
});

clearCurrentBtn.addEventListener('click', clearDrawing);

addHotspotBtn.addEventListener('click', () => {
  if (points.length < 3 || !isClosed) return;

  const hotspot = {
    id: hotspotIdInput.value.trim() || `hotspot_${sceneHotspots.length + 1}`,
    label: hotspotLabelInput.value.trim() || hotspotIdInput.value.trim() || `Hotspot ${sceneHotspots.length + 1}`,
    points: points.map(({x, y}) => ({x, y})),
  };

  const target = hotspotTargetInput.value.trim();
  if (target) {
    hotspot.targetScene = target;
  }

  sceneHotspots.push(hotspot);

  // Clear inputs
  hotspotIdInput.value = '';
  hotspotLabelInput.value = '';
  hotspotTargetInput.value = '';

  clearDrawing();
  renderExistingHotspots();
  updateHotspotList();
  updateJsonOutput();
  updateStatus(`Added hotspot "${hotspot.id}". Don't forget to Download!`);
});

deleteBtn.addEventListener('click', () => {
  if (selectedHotspotIndex < 0) return;
  const removed = sceneHotspots.splice(selectedHotspotIndex, 1)[0];
  selectedHotspotIndex = -1;
  deleteBtn.disabled = true;
  renderExistingHotspots();
  updateHotspotList();
  updateJsonOutput();
  updateStatus(`Deleted "${removed.id || 'hotspot'}". Don't forget to Download!`);
});

downloadBtn.addEventListener('click', downloadStationMap);

loadBtn.addEventListener('click', () => loadFile.click());
loadFile.addEventListener('change', (e) => {
  if (e.target.files.length > 0) {
    loadStationMapFromFile(e.target.files[0]);
  }
});

// Initialize
const initialScene = getUrlParam('scene') || 'station';
currentSceneId = initialScene;

// Try to load station-map.json from same directory
fetch('station-map.json')
  .then(res => res.ok ? res.json() : Promise.reject('Not found'))
  .then(data => {
    stationMap = data;
    populateSceneSelect();
    loadScene(currentSceneId);
  })
  .catch(() => {
    // Use default map
    populateSceneSelect();
    loadScene(currentSceneId);
    updateStatus('Using default map. Load your station-map.json to edit existing hotspots.');
  });
</script>

</body>
</html>
